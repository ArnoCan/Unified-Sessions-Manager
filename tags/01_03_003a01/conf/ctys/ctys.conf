#!/bin/bash

########################################################################
#
#PROJECT:      Unified Sessions Manager
#AUTHOR:       Arno-Can Uestuensoez - acue@UnifiedSessionsManager.org
#MAINTAINER:   Arno-Can Uestuensoez - acue_sf1@sourceforge.net
#SHORT:        ctys
#CALLFULLNAME: Commutate To Your Session
#LICENCE:      GPL3
#VERSION:      01_02_007a17
#
########################################################################
#
# Copyright (C) 2007 Arno-Can Uestuensoez (UnifiedSessionsManager.org)
#
########################################################################


################################################################
#    Default definitions - User-Customizable  from shell       #
################################################################

#
#
#The following variables force control on the state of addressed
#plugins when present. The scope of control is local only.
#
#
#The syntax is:
#
#
#   export <plugin-type>_IGNORE=1
#
#
#When set, the bootstrap-loader ignores the given <plugin-type>.
#This should be in case of dependencies such as of XEN from VNC
#utilized carefully. But on machines with OpenBSD e.g. the plugins
#VMW and XEN could be set to ignore safely.
#
#export PM_IGNORE=1
#export CLI_IGNORE=1
#export X11_IGNORE=1
#export VNC_IGNORE=1
#export XEN_IGNORE=1
#export VMW_IGNORE=1
#export QEMU_IGNORE=1
#export OVZ_IGNORE=1
#
#
# This could be configured conditionally for each of the following
# variables, and any other valid shell variable.
# This is particularly helpful in case of NFS mounted home directories
# sharing the identical user-configuration for multiple machines within 
# a cluster:
#
#   MYHOST   : actual host
#   MYOS     : actual OS
#   MYOSREL  : release of actual OS
#   MYDIST   : actual distribution
#   MYREL    : release of actual distribution
#
#
# Some examples for ignoring of XEN-plugin on specific sets of 
# nodes:
#
#   ->host01 only
#     [ "$MYHOST" == "host01" ]&&export XEN_IGNORE=1;
#
#   ->Any node NOT on "clust0*"
#     [ "${MYHOST#clust0*}" == "${MYHOST}" ]&&export XEN_IGNORE=1;
#
#   ->Any node IS on "clust0*"
#     [ "${MYHOST#clust0*}" != "${MYHOST}" ]&&export XEN_IGNORE=1;
#
#   ->Any node in domain "exe1"
#     [ "${MYHOST##*.exe1}" == "${MYHOST}" ]&&export XEN_IGNORE=1;
#
#   ->Any node NOT running OpenBSD
#     [ "${MYOS}" != "OpenBSD" ]&&export XEN_IGNORE=1;
#
#   ->Any node IS running Linux
#     [ "${MYOS}" == "Linux" ]&&export XEN_IGNORE=1;
#
#   ->Any node IS running CentOS
#     [ "${MYDIST}" == "CentOS" ]&&export XEN_IGNORE=1;
#
#   ->Any node which IS NOT final execution target
#     [ -z "$CTRL_EXECLOCAL" ]&&export XEN_IGNORE=1;
#
#   ->....
#
#
# Almost any combination and any additional constraint could be
# added by means of bash.
#
# When using internal state variables the user is responsible for
# any resulting side effect.
#


##################
#Configuration of supported contexts for standard plugins.
#

#PM supports currently Linux and OpenBSD
[ "${MYOS}" != "OpenBSD" -a "${MYOS}" != "Linux" ]&&export PM_IGNORE=1;

#XEN is supported on Linux only as server, else as client only.
#VNC check will be done by plugin
#Check for "-e", because CTRL_EXECLOCAL is not yet initialized.
_lchk=`echo " $* "| sed -n '/ -e /p'`
[ "${MYOS}" != "Linux" -a -n "$_lchk" ]&&export XEN_IGNORE=1;

#VMW is supported on Linux only, else as client only.
#Native local client and VNC access for WS6 will be checked by plugin.
[ "${MYOS}" != "Linux" ]&&export VMW_IGNORE=1;

###########################################################################
#                                                                         #
#ATTENTION:                                                               #
#  The plugins CLI+X11+VNC could be called MANDATORY for others, so       #
#  their "IGNORE-ance" might force unforseen side-effects, think twice!!! #
#                                                                         #
#  Same is true for PM when you require WoL and controlled PM shutdown,   #
#  what might be obvious!                                                 #
#                                                                         #
###########################################################################



###################
#generic
DEFAULT_CTRL_SESSIONTYPE=${DEFAULT_CTRL_SESSIONTYPE:-VNC}
DEFAULT_CTRL_SCOPE=${DEFAULT_CTRL_SCOPE:-USER}
DEFAULT_KILL_DELAY_POWEROFF=${DEFAULT_KILL_DELAY_POWEROFF:-20}
DEFAULT_LIST_CONTENT=${DEFAULT_LIST_CONTENT:-ALL,FULLPATH,BOTH}

#The account to be used for generic network actions.
#When root permissions are required, the user root will be 
#called, but has to be preconfigured for network login or a 
#password authentication will be requested.
CTYS_NETACCOUNT=${CTYS_NETACCOUNT:-$USER}


###################
#CREATE
DEFAULT_CTRL_MODE_ARGS=${DEFAULT_CTRL_MODE_ARGS_CREATE:-'1,DEFAULT,REUSE'}


###################
#LIST
 DEFAULT_CTRL_MODE_ARGS_LIST=${DEFAULT_CTRL_MODE_ARGS_LIST:-"label,id,user,group,pid"}
# DEFAULT_LIST_CTRL_SCOPE="USRLST"
# DEFAULT_LIST_CTRL_SCOPE_ARGS="all"


###################
#ENUMERATE
DEFAULT_CTRL_MODE_ARGS_ENUMERATE=${DEFAULT_CTRL_MODE_ARGS_ENUMERATE:-'.'}




################################################################
#Globalized convenience settings for Basic-Community-Packages  #
################################################################


#Common: Defines the timeout an established port-forwarding tunnel by 
#OpenSSH.
#Should wait for it's first and only one (just an wannabee oneshot - within
#the period any number of connects are possible) connection. This is choosen,
#because because now no precautions have to be and are not implemented for
#cancellation of no longer required tunnels. So you might no set a high value,
#just smallerr than a minute.
#Existing ports are not reused anyway, because the next tunnel-request
#increments the highest present for a new tunnel.
#
#APPLY:Increment when clients do not connect with ConnectionForwarding.
SSH_ONESHOT_TIMEOUT=${SSH_ONESHOT_TIMEOUT:-20}



#Common: Defines the timeout to delay the start of a client after server
#
#APPLY:Increment this value when clients do not connect.
R_CLIENT_DELAY=${R_CLIENT_DELAY:-2}



#Common: Defines the timeout after all XClients of one desktop are 
#started. Due to problems with reliability a shift of distinguished 
#windows seems not to work(at least in my environment on CentOS-5.0/Gnome).
#So current desktop is switched for default pop-up on target desktop
#which could take some time until the window actually is displayed.
#When the desktop is meanwhile switched the window will be positioned 
#on the current if not yet displayed.
#Depends on actual base, it seems that at least 5seconds are required,
#for safety 8 seconds are choosen.
#
#APPLY:Increment this value when clients pop-up on wrong desktop.
X_DESKTOPSWITCH_DELAY=${X_DESKTOPSWITCH_DELAY:-8}



################################################################
#Basic-Package Settings: VNC
#
#General remarks: 
# The geometry parameter will be reset - for server too - when selected
# at the CLI by "-g" option. So the value here is just a default, when no 
# call parameter is supported.
#

#Bulk: Defines the timeout to wait between bulk creation of sessions 
R_CREATE_TIMEOUT=${R_CREATE_TIMEOUT:-5}



#Bulk: Defines the maximum allowed number of sessions to be created by a bulk call.
#ATTENTION:Mistakenly using e.g. 1000 will probably force you to reboot your machines!!!!
#A call of "ctys -a cancel=all poorHost" might help?!
#
#APPLY:Increment this when more VNC-bulk sessions on a node are required.
R_CREATE_MAX=${20}


#Delay after call of VNCserver, before execution of VNCviewer.
#Only required on fast machines, though due to dialogue-response it should be  set
#moderately.
#If not, sometimes the client tries to attach too fast, before the server is ready.
#This leads to immediate termination of the client only with "BadAccess" Error, an 
#following connect will succeed. 
VNCVIEWER_DELAY=${VNCVIEWER_DELAY:-3}

#######wrapper for vncviewer
VNCVIEWER=${MYCALLPATH}/ctys-callVncviewer

#######wrapper for vncserver
VNCSERVER=${MYCALLPATH}/ctys-callVncserver


################################################################
#Basic-Package Settings: XEN
#ffs.


################################################################
#Guest-OS connection

#
#The TCP/IP address or hostename of the guest OS the connection 
#has to be established to.
#If this is provided, it has highest priority and will be used.
GUEST_IP=DEFAULT

#
#The name of the file from which the guest OS information should be 
#fetsched. The highest priority has 0, when read successful, the 
#others will be ignored.
#
# 0. This will be evaluated, when GUEST_IP is not provided.
#
#    The content will be scanned for an entry of the following 
#    form, which has to be administered manually by the user:
#
#    ${GUEST_CONFPREFIX}CTYS-IP=<ip-address>|<hostname>[:<ssh-port>]
#
#Letting this with DEFAULT, evaluates the given <vm-name> with the 
#following algorithm in order to get mapping information from VM
#to the guest OS, which is in this case a session of type HOST.
#
# 1. <vm-name-directory>/<vm-config-file>
#    Evaluation same as for 0.). 
#
# 2. Else:
#    <vm-name-directory>/<vm-config-file>.ctys
#    Evaluation same as for 0.). 
#
# 2. Else:
#    <vm-name-directory>.ctys
#    Evaluation same as for 0.). 
#
#
GUEST_DATAFILE=DEFAULT

#
#Common prefix for ctys-extensions in shell-files
GUEST_CONFPREFIX_SH='#@#'



################################################################
#Miscellaneous settings

#Options for formatting text with "pr" when printing out the embedded help.
PR_OPTS=${PR_OPTS:--o 5 -l 73 -F}




#Using this as a ready to use option, some lengthy keywords for now,
#but recognition has priority over string replace-functions!
CTRL_CLIENTLOCATION="${CTRL_CLIENTLOCATION:--L DisplayForwarding}"



#Base for remapping of local client access ports for ConnectionForwarding.
#Even though released curretnly for user-setting, you might know what you
#are doing. don't blame me, or ctys!
LOCAL_PORTREMAP=${LOCAL_PORTREMAP:-5950}



#Is defined to be used when set, so it is foreseen as test-path for remote call
#R_PATH



#Is defined to be used when set, so it is foreseen as test-path for local call
#L_PATH


#The default directory-path for the mapping database of ctys.
DEFAULT_DBPATHLST=${DEFAULT_DBPATHLST:-$MYCONFPATH/db/default}


#The storage for pre-configured access-groups
CTYS_GROUPS_PATH=${CTYS_GROUPS_PATH:-$MYCONFPATH/groups} 


#The default directory used for temporary data
MYTMP=/tmp/ctys.${USER}
[ -d ${MYTMP} ]||mkdir ${MYTMP}
if [ ! -d ${MYTMP} ];then
  echo "${BASH_SOURCE}:${LINENO}:ERROR:Cannot create MYTMP=${MYTMP}"
  exit 1;
fi


#default base directories for enumeration trees
DEFAULT_ENUM_BASE="$HOME $RS_PREFIX_R $RS_PREFIX_L /etc/ctys.d"

