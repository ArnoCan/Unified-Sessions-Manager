#!/bin/bash

########################################################################
#
#PROJECT:      Unified Sessions Manager
#AUTHOR:       Arno-Can Uestuensoez - acue@UnifiedSessionsManager.org
#MAINTAINER:   Arno-Can Uestuensoez - acue_sf1@sourceforge.net
#SHORT:        ctys
#CALLFULLNAME: Commutate To Your Session
#LICENCE:      GPL3
#VERSION:      01_03_002a02
#
########################################################################
#
# Copyright (C) 2007 Arno-Can Uestuensoez (UnifiedSessionsManager.org)
#
########################################################################


#
#If required, this wrapper could be build as complex as e.g. 
#callVncviewer or callVncserver.
#


#from test examples of QEMU

#####################
#
#The following environment variables are used if set, else as default.
#

. ./bootstrap.01.01.001

MYOS=`getCurOS`
MYCONF=$HOME/.ctys/qemu/qemu.conf.${MYOS}
if [ -f "${MYCONF}" ];then
    . ${MYCONF}
fi

#
#The socket for access to VDE's virtual switch port: vde_switch
QEMUSOCK=${QEMUSOCK:-/var/tmp/vde_switch0.$USER}

#
#inherited by export, but normally as defined here
QEMUBIOS=${QEMUBIOS:-$HOME/qemu/pc-bios}

#
#inherited by export, but normally as defined here
#QEMU=${QEMU:-vdeqemu}
QEMU=vdeq


#####################
#
#The following CLI parameters will be supported to the call of this script:
#
#  
#  $1:DISPLAYMODE
#       CLI: To be used in a terminal
#       SDL: To be used for X11 GUI.
#       VNC: To be used for VNC, this is the only mode which supports 
#            ConnectionForwarding too.
#
#       REMARK: XTERM and GTERM are just encapsulated CLI calls.
#
#
#  $2:BOOTMODE
#       PXE: Will boot by PXE, this is currently only available for 
#            x86 platforms.
#
#            Could be used for initial install, and e.g. boot-strapping 
#            Kickstart of course.
#

DISPMODE=$1;shift
BOOTMODE=$1;shift

ARGSADD=$*


################################################
################################################

MYCALLPATH=`bootstrapGetRealPathname ${0%/*}`
MYCALLNAME=`basename $0`



################################
#
#Values required for ENUMERATE, even though some values, e.g. UUID
#are currently not yet actually utilized by the QEMU-VM itself.
#The values are used as search key within the ctys-name-services. 
#So it makes "heavyly" sence to maintain them thoroughly, and keep
#all values unique, where applicable.
#

#@#MAGICID-QEMU
#@#LABEL              = "sparc-1"
LABEL="sparc-1"
#@#SESSIONTYPE        = "QEMU-S-Sparc"
#@#UUID               = "a9eb7c12c6304e80b3245175ba122f37"
#@#MAC0               = "00:50:56:13:11:49"
MAC0="00:50:56:13:11:49"
# by DHCP @#IP0                = 
#@#VNCACCESSPORT      = 
#@#VNCBASEPORT        = 
#@#VNCACCESSDISPLAY   = "21"
VNCACCESSDISPLAY=21
#@#DISTRO             = "QEMU"
#@#DISTROREL          = "0.9.1"
#@#OS                 = "Linux"
#@#VERSION            = "2.6.11+tcx"
#@#SERNR              = 
#@#CATEGORY           = "VM"


####################################
#
#Start assembly of call.
#

#
#ATTENTION:
#  Full path required for ps-based LIST, so do not 
#  change this, but the device as required.
LASTPATH=" -kernel ${MYCALLPATH}/vmlinux-2.6.11+tcx "


#QCALL="${QEMUCALL} ${QEMU} ";
QCALL="${QEMU} qemu-system-sparc ";

QCALL="${QCALL} -initrd linux.img -append \"root=/dev/ram\" "

#QCALL="${QCALL} -m 384 "
QCALL="${QCALL} -localtime "
#QCALL="${QCALL} -k de "
QCALL="${QCALL} -L ${QEMUBIOS} "
QCALL="${QCALL} -net nic,macaddr=${MAC0} "
QCALL="${QCALL} -net vde,sock=${QEMUSOCK} "


case ${BOOTMODE} in
    PXE)
    QCALL="${QCALL} -boot n -no-reboot"
    QCALL="${QCALL} -option-rom ${QEMUBIOS}/pxe-ne2k_pci.bin "
    ;;
esac


case ${DISPMODE} in
    CLI)
       #without graphical output
#       $QCALL -nographic -append "console=ttyAMA0" ${ARGSADD}
#       $QCALL -nographic  ${ARGSADD}
	echo "Unsupported DISPMODE=\"${DISPMODE}\"">&2
	exit 127
	;;
    SDL)
       #with graphical output
	$QCALL  ${ARGSADD} 
	;;
    VNC)
	$QCALL  -vnc :${VNCACCESSDISPLAY}  ${ARGSADD}  ${LASTPATH}
	;;
    *)
	echo "Unknown display DISPMODE=\"${DISPMODE}\"">&2
	exit 127
	;;
esac


